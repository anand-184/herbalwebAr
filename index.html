<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Virtual Herbal Garden AR</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ar.js@1.7.2/aframe/build/aframe-ar.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; }
        #controls {
            position: absolute; top: 10px; left: 10px; z-index: 100;
            background: rgba(255,255,255,0.8); padding: 10px;
            border-radius: 8px; display: flex; flex-direction: column; gap: 8px;
        }
        select, button {
            padding: 8px 12px; font-size: 14px; border: 1px solid #ccc;
            border-radius: 4px; background: white;
        }
        .plant-highlight {
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 5px 2px rgba(0,255,0,0.5); }
            100% { box-shadow: 0 0 15px 5px rgba(0,255,0,0.2); }
        }
    </style>
</head>
<body>
    <!-- Controls -->
    <div id="controls">
        <select id="plantSelector">
            <option value="models/Coffee_plant.glb">üåø Coffee</option>
            <option value="models/Flower.glb">‚òï Flower</option>
            <option value="models/rosemary.glb">üå± Aloe Vera</option>
            <option value="models/shelf_plants.glb">üå± shelf</option>
        </select>
        <button id="addModelButton">‚ûï Add Plant</button>
        <button id="deleteButton" style="display:none;">üóëÔ∏è Delete Selected</button>
    </div>

    <!-- AR Scene -->
    <a-scene 
        vr-mode-ui="enabled: false"
        arjs="sourceType: webcam; 
              debugUIEnabled: false;
              detectionMode: mono_and_matrix;
              matrixCodeType: 3x3;
              cameraParametersUrl: https://raw.githubusercontent.com/jeromeetienne/ar.js/master/data/data/camera_para.dat"
        renderer="logarithmicDepthBuffer: true; antialias: true; alpha: true">
        
        <a-camera gps-camera rotation-reader></a-camera>
        <a-entity id="plantsContainer"></a-entity>
    </a-scene>

    <script>
        // Initialize variables
        const plantSelector = document.getElementById('plantSelector');
        const addModelButton = document.getElementById('addModelButton');
        const deleteButton = document.getElementById('deleteButton');
        const plantsContainer = document.getElementById('plantsContainer');
        let selectedPlant = null;
        let touchStartTime = 0;
        let touchStartX = 0;
        let touchStartY = 0;
        let initialDistance = 0;
        let initialScale = { x: 0.2, y: 0.2, z: 0.2 };

        // Add new plant
        addModelButton.addEventListener('click', function() {
            const modelUrl = plantSelector.value;
            addPlant(modelUrl);
        });

        // Delete selected plant
        deleteButton.addEventListener('click', function() {
            if (selectedPlant) {
                plantsContainer.removeChild(selectedPlant);
                selectedPlant = null;
                deleteButton.style.display = 'none';
            }
        });

        // Add plant with random position within camera view
        function addPlant(modelUrl) {
            const plant = document.createElement('a-entity');
            const xPos = (Math.random() * 1 - 0.5); // Constrained to center area
            const zPos = (Math.random() * -1.5) - 1; // Position in front of camera
            
            plant.setAttribute('gltf-model', `url(${modelUrl})`);
            plant.setAttribute('position', `${xPos} 0 ${zPos}`);
            plant.setAttribute('scale', '0.2 0.2 0.2');
            plant.setAttribute('rotation', `0 ${Math.random() * 360} 0`);
            plant.setAttribute('class', 'plant');
            plant.setAttribute('gesture-handler', '');
            
            plantsContainer.appendChild(plant);
        }

        // Enhanced gesture handler component
        AFRAME.registerComponent('gesture-handler', {
            init: function() {
                const el = this.el;
                let isDragging = false;
                
                // Touch start - select plant
                el.addEventListener('touchstart', function(evt) {
                    evt.preventDefault();
                    touchStartTime = Date.now();
                    touchStartX = evt.touches[0].clientX;
                    touchStartY = evt.touches[0].clientY;
                    
                    // Deselect previous plant
                    if (selectedPlant) {
                        selectedPlant.removeAttribute('class', 'plant-highlight');
                    }
                    
                    // Select this plant
                    selectedPlant = el;
                    el.setAttribute('class', 'plant plant-highlight');
                    deleteButton.style.display = 'block';
                    
                    // For pinch zoom
                    if (evt.touches.length === 2) {
                        initialDistance = getDistance(evt.touches[0], evt.touches[1]);
                        initialScale = {
                            x: el.getAttribute('scale').x,
                            y: el.getAttribute('scale').y,
                            z: el.getAttribute('scale').z
                        };
                    }
                }, {passive: false});
                
                // Touch move - drag or scale
                el.addEventListener('touchmove', function(evt) {
                    evt.preventDefault();
                    
                    // Single touch - drag
                    if (evt.touches.length === 1 && selectedPlant === el) {
                        const touch = evt.touches[0];
                        const moveX = touch.clientX - touchStartX;
                        const moveY = touch.clientY - touchStartY;
                        
                        if (Math.abs(moveX) > 5 || Math.abs(moveY) > 5) {
                            isDragging = true;
                            const currentPos = el.getAttribute('position');
                            const newX = currentPos.x + (moveX * 0.01);
                            const newZ = currentPos.z + (moveY * 0.01);
                            
                            // Constrain movement to camera view
                            el.setAttribute('position', {
                                x: Math.min(Math.max(newX, -1), 1),
                                y: 0,
                                z: Math.min(Math.max(newZ, -2.5), -0.5)
                            });
                            
                            touchStartX = touch.clientX;
                            touchStartY = touch.clientY;
                        }
                    }
                    
                    // Two touches - scale
                    if (evt.touches.length === 2 && selectedPlant === el) {
                        const newDistance = getDistance(evt.touches[0], evt.touches[1]);
                        const scaleFactor = newDistance / initialDistance;
                        
                        const newScale = {
                            x: initialScale.x * scaleFactor,
                            y: initialScale.y * scaleFactor,
                            z: initialScale.z * scaleFactor
                        };
                        
                        // Limit scaling
                        newScale.x = Math.min(Math.max(newScale.x, 0.1), 1.5);
                        newScale.y = Math.min(Math.max(newScale.y, 0.1), 1.5);
                        newScale.z = Math.min(Math.max(newScale.z, 0.1), 1.5);
                        
                        el.setAttribute('scale', newScale);
                    }
                }, {passive: false});
                
                // Touch end
                el.addEventListener('touchend', function(evt) {
                    evt.preventDefault();
                    
                    // If it was a tap (not drag)
                    if (!isDragging && (Date.now() - touchStartTime < 300)) {
                        if (selectedPlant) {
                            selectedPlant.removeAttribute('class', 'plant-highlight');
                        }
                        selectedPlant = el;
                        el.setAttribute('class', 'plant plant-highlight');
                        deleteButton.style.display = 'block';
                    }
                    
                    isDragging = false;
                }, {passive: false});
                
                // Calculate distance between two touches
                function getDistance(touch1, touch2) {
                    return Math.sqrt(
                        Math.pow(touch2.clientX - touch1.clientX, 2) +
                        Math.pow(touch2.clientY - touch1.clientY, 2)
                    );
                }
            }
        });
    </script>
</body>
</html>