<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Virtual Herbal Garden AR</title>

    <!-- A-Frame and AR.js -->
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ar.js@1.7.2/aframe/build/aframe-ar.min.js"></script>

    <style>
        body { margin: 0; overflow: hidden; font-family: Arial, sans-serif; }
        #controls {
            position: absolute; top: 10px; left: 10px; z-index: 10;
            background: rgba(255, 255, 255, 0.9); padding: 10px;
            border-radius: 8px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            display: flex; flex-direction: column; gap: 10px;
        }
        select, button {
            padding: 10px; font-size: 16px;
            border: 1px solid black; border-radius: 5px; cursor: pointer;
        }
        .plant-highlight {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(0, 255, 0, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(0, 255, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 255, 0, 0); }
        }
    </style>
</head>
<body>

    <!-- Controls -->
    <div id="controls">
        <select id="plantSelector">
            <option value="models/Plant.glb">üåø Tulsi</option>
            <option value="models/Coffee_plant.glb">‚òï Coffee</option>
            <option value="models/rosemary.glb">üå± Aloe Vera</option>
            <option value="models/shelf_plants.glb">‚òòÔ∏è Shelf Plants</option>
            <option value="models/Flower_Pot.glb">ü™¥ Flower Pot</option>
        </select>
        <button id="addModelButton">‚ûï Add New Plant</button>
        <button id="deleteButton" style="display:none;">üóëÔ∏è Delete Selected</button>
    </div>

    <!-- AR Scene -->
    <a-scene embedded arjs="sourceType: webcam; facingMode: environment; debugUIEnabled: false;">
        <a-camera gps-camera rotation-reader></a-camera>

        <!-- Lighting -->
        <a-entity light="type: directional; intensity: 1.2" position="1 3 3"></a-entity>
        <a-entity light="type: ambient; intensity: 0.5"></a-entity>

        <!-- Container for multiple plants -->
        <a-entity id="plantsContainer"></a-entity>
    </a-scene>

    <script>
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                console.log("Camera access granted:", stream);
            } catch (error) {
                console.error("Camera access denied:", error);
                alert("Please enable camera permissions in settings.");
            }
        }
        window.onload = startCamera;

        let plantSelector = document.getElementById("plantSelector");
        let addModelButton = document.getElementById("addModelButton");
        let deleteButton = document.getElementById("deleteButton");
        let plantsContainer = document.getElementById("plantsContainer");
        let selectedPlant = null;
        let touchStartTime = 0;
        let touchStartX = 0;
        let touchStartY = 0;

        function createPlantModel(selectedPlant) {
            let newPlant = document.createElement("a-entity");

            // Generate random positions
            let randomX = (Math.random() * 4 - 2).toFixed(2);
            let randomZ = (Math.random() * 4 - 3).toFixed(2);
            let randomY = (Math.random() * 0.5).toFixed(2);

            newPlant.setAttribute("gltf-model", selectedPlant);
            newPlant.setAttribute("position", `${randomX} ${randomY} ${randomZ}`);
            newPlant.setAttribute("scale", "0.2 0.2 0.2");
            newPlant.setAttribute("rotation", `0 ${Math.random() * 360} 0`);
            newPlant.setAttribute("class", "plant");
            newPlant.setAttribute("gesture-controls", "");

            plantsContainer.appendChild(newPlant);
            console.log("Added new model at:", randomX, randomY, randomZ);
        }

        addModelButton.addEventListener("click", function() {
            let selectedPlantModel = plantSelector.value;
            createPlantModel(selectedPlantModel);
        });

        deleteButton.addEventListener("click", function() {
            if (selectedPlant) {
                selectedPlant.parentNode.removeChild(selectedPlant);
                selectedPlant = null;
                deleteButton.style.display = "none";
            }
        });

        // Enhanced gesture controls
        AFRAME.registerComponent('gesture-controls', {
            init: function () {
                let el = this.el;
                let scale = { x: 0.2, y: 0.2, z: 0.2 };
                let isDragging = false;
                let startDistance = 0;
                let initialScale = { x: 0.2, y: 0.2, z: 0.2 };

                // Touch start handler
                el.addEventListener('touchstart', function (e) {
                    e.preventDefault();
                    touchStartTime = Date.now();
                    touchStartX = e.touches[0].clientX;
                    touchStartY = e.touches[0].clientY;
                    
                    // Select the plant
                    if (selectedPlant) {
                        selectedPlant.removeAttribute('animation');
                        selectedPlant.removeAttribute('class', 'plant-highlight');
                    }
                    selectedPlant = el;
                    el.setAttribute('class', 'plant plant-highlight');
                    deleteButton.style.display = "block";
                    
                    // For two-finger gestures
                    if (e.touches.length === 2) {
                        startDistance = getDistance(e.touches[0], e.touches[1]);
                        initialScale = {
                            x: el.getAttribute('scale').x,
                            y: el.getAttribute('scale').y,
                            z: el.getAttribute('scale').z
                        };
                    }
                }, {passive: false});

                // Touch move handler for dragging
                el.addEventListener('touchmove', function (e) {
                    e.preventDefault();
                    
                    // Single touch - drag
                    if (e.touches.length === 1 && selectedPlant === el) {
                        let touch = e.touches[0];
                        let newX = (touch.clientX / window.innerWidth) * 4 - 2;
                        let newZ = (touch.clientY / window.innerHeight) * 4 - 2;
                        
                        // Check if this is a significant movement to avoid accidental drags
                        if (Math.abs(touch.clientX - touchStartX) > 10 || 
                            Math.abs(touch.clientY - touchStartY) > 10) {
                            isDragging = true;
                            el.setAttribute('position', `${newX} 0 ${newZ}`);
                        }
                    }
                    
                    // Two touches - scale
                    if (e.touches.length === 2 && selectedPlant === el) {
                        let newDistance = getDistance(e.touches[0], e.touches[1]);
                        let scaleFactor = newDistance / startDistance;
                        
                        let newScale = {
                            x: initialScale.x * scaleFactor,
                            y: initialScale.y * scaleFactor,
                            z: initialScale.z * scaleFactor
                        };
                        
                        // Limit scaling
                        newScale.x = Math.min(Math.max(newScale.x, 0.1), 3);
                        newScale.y = Math.min(Math.max(newScale.y, 0.1), 3);
                        newScale.z = Math.min(Math.max(newScale.z, 0.1), 3);
                        
                        el.setAttribute("scale", `${newScale.x} ${newScale.y} ${newScale.z}`);
                    }
                }, {passive: false});

                // Touch end handler
                el.addEventListener('touchend', function (e) {
                    e.preventDefault();
                    
                    // If it was a short tap without movement, consider it a selection
                    if (!isDragging && (Date.now() - touchStartTime < 300)) {
                        if (selectedPlant) {
                            selectedPlant.removeAttribute('animation');
                            selectedPlant.removeAttribute('class', 'plant-highlight');
                        }
                        selectedPlant = el;
                        el.setAttribute('class', 'plant plant-highlight');
                        deleteButton.style.display = "block";
                    }
                    
                    isDragging = false;
                }, {passive: false});

                function getDistance(touch1, touch2) {
                    return Math.sqrt(
                        Math.pow(touch2.clientX - touch1.clientX, 2) + 
                        Math.pow(touch2.clientY - touch1.clientY, 2)
                    );
                }
            }
        });
    </script>
</body>
</html>