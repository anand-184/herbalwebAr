<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Virtual Herbal Garden AR</title>

    <!-- A-Frame and AR.js -->
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ar.js@1.7.2/aframe/build/aframe-ar.min.js"></script>

    <style>
        body { margin: 0; overflow: hidden; font-family: Arial, sans-serif; }
        #controls {
            position: absolute; top: 10px; left: 10px; z-index: 10;
            background: rgba(255, 255, 255, 0.9); padding: 10px;
            border-radius: 8px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            display: flex; flex-direction: column; gap: 10px;
        }
        select, button {
            padding: 10px; font-size: 16px;
            border: 1px solid black; border-radius: 5px; cursor: pointer;
        }
    </style>
</head>
<body>

    <!-- Controls -->
    <div id="controls">
        <select id="plantSelector">
            <option value="models/Plant.glb">üåø Tulsi</option>
            <option value="models/Coffee_plant.glb">‚òï Coffee</option>
            <option value="models/rosemary.glb">üå± Aloe Vera</option>
            <option value="models/shelf_plants.glb">‚òòÔ∏è Shelf Plants</option>
            <option value="models/Flower_Pot.glb">ü™¥ Flower Pot</option>
        </select>
        <button id="addModelButton">‚ûï Add New Plant</button>
    </div>

    <!-- AR Scene -->
    <a-scene embedded arjs="sourceType: webcam; facingMode: environment; debugUIEnabled: false;">
        <a-camera gps-camera rotation-reader></a-camera>

        <!-- Lighting -->
        <a-entity light="type: directional; intensity: 1.2" position="1 3 3"></a-entity>
        <a-entity light="type: ambient; intensity: 0.5"></a-entity>

        <!-- Container for multiple plants -->
        <a-entity id="plantsContainer"></a-entity>
    </a-scene>

    <script>
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                console.log("Camera access granted:", stream);
            } catch (error) {
                console.error("Camera access denied:", error);
                alert("Please enable camera permissions in settings.");
            }
        }
        window.onload = startCamera;

        let plantSelector = document.getElementById("plantSelector");
        let addModelButton = document.getElementById("addModelButton");
        let plantsContainer = document.getElementById("plantsContainer");
        let selectedPlant = null;  // Track the selected plant

        function createPlantModel(selectedPlant) {
            let newPlant = document.createElement("a-entity");

            // Generate random positions
            let randomX = (Math.random() * 4 - 2).toFixed(2);
            let randomZ = (Math.random() * 4 - 3).toFixed(2);
            let randomY = (Math.random() * 0.5).toFixed(2);

            // Assign attributes properly
            newPlant.setAttribute("gltf-model", selectedPlant);
            newPlant.setAttribute("position", `${randomX} ${randomY} ${randomZ}`);
            newPlant.setAttribute("scale", "0.2 0.2 0.2");  // Set smaller size initially
            newPlant.setAttribute("rotation", `0 ${Math.random() * 360} 0`);
            newPlant.setAttribute("class", "plant");

            // Add tap event to select the plant
            newPlant.addEventListener("click", function () {
                selectedPlant = newPlant;
                console.log("Selected plant:", selectedPlant);
            });

            plantsContainer.appendChild(newPlant);
            console.log("Added new model at:", randomX, randomY, randomZ);
        }

        addModelButton.addEventListener("click", function() {
            let selectedPlantModel = plantSelector.value;
            createPlantModel(selectedPlantModel);
        });

        // Touch Gesture Handling for Resizing
        let startDistance = 0;

        function getDistance(touch1, touch2) {
            return Math.sqrt(Math.pow(touch2.clientX - touch1.clientX, 2) + Math.pow(touch2.clientY - touch1.clientY, 2));
        }

        document.addEventListener("touchstart", function (event) {
            if (event.touches.length === 2 && selectedPlant) {
                startDistance = getDistance(event.touches[0], event.touches[1]);
            }
        });

        document.addEventListener("touchmove", function (event) {
            if (event.touches.length === 2 && selectedPlant) {
                let newDistance = getDistance(event.touches[0], event.touches[1]);
                let scaleFactor = newDistance / startDistance;

                // Get the current scale and update it
                let currentScale = selectedPlant.getAttribute("scale");
                let newScale = {
                    x: Math.min(Math.max(currentScale.x * scaleFactor, 0.1), 3),
                    y: Math.min(Math.max(currentScale.y * scaleFactor, 0.1), 3),
                    z: Math.min(Math.max(currentScale.z * scaleFactor, 0.1), 3)
                };

                selectedPlant.setAttribute("scale", `${newScale.x} ${newScale.y} ${newScale.z}`);
                console.log("Resized:", newScale);

                startDistance = newDistance;
            }
        });
    </script>

</body>
</html>
